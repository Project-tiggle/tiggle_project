<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC
"-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="orgRegistMapper">

	<resultMap id="resultOrgRegist" type="OrgRegist">
	       <result property="uuid" column="UUID" />
	       <result property="totalId" column="TOTAL_ID" />
	       <result property="title" column="TITLE" />
	       <result property="contributor" column="CONTRIBUTOR" />
	       <result property="eDescription" column="E_DESCRIPTION" />
	       <result property="eventSite" column="EVENT_SITE" />
	       <result property="detailEventSite" column="DETAIL_EVENT_SITE" />
	       <result property="latitude" column="LATITUDE" />
	       <result property="longitude" column="LONGITUDE" />
	       <result property="genre" column="GENRE" />
	       <result property="contactPoint" column="CONTACT_POINT" />
	       <result property="viewCounter" column="VIEW_COUNTER" />
	       <result property="eUrl" column="E_URL" />
	       <result property="startDate" column="START_DATE" />
	       <result property="endDate" column="END_DATE" />
	       <result property="approvalStatus" column="APPROVAL_STATUS" />
	       <result property="eCategory" column="E_CATEGORY" />
	       <result property="fileUrl" column="FILE_URL" />
	       <result property="name" column="NAME" />
	       <result property="mngDept" column="MNG_DEPT" />
	       <result property="mngJobId" column="MNG_JOBID" />
	       <result property="phone" column="PHONE" />
	       <result property="email" column="EMAIL" />
	</resultMap>
	
	<!-- 기업용 쿼리 -->
	<!-- 전시등록 총 갯수 조회용 쿼리 -->
	<select id="selectListCount" resultType="_int" parameterType="string">
		select count(*)
		from tb_exhibition_fair
		where uuid = #{ uuid }
	</select>
	
	<!-- 요청한 페이지에 출력할 게시글 리스트 조회용 쿼리 -->
	<select id="selectList" resultMap="resultOrgRegist" parameterType="map">
		select *
		from (select rownum rnum, TITLE, NAME, START_DATE, END_DATE, TOTAL_ID
		      from (select *
		            from tb_exhibition_fair
		            join tb_member using (uuid)
		            where uuid = #{ uuid })
		      order by start_date)
		where rnum between #{ paging.startRow } and #{ paging.endRow }
	</select>
	
	<!-- 전시/박람회 등록하기(insert & update) -->
	<insert id="insertOrgRegist" parameterType="OrgRegist">
		insert into tb_exhibition_fair
		values (#{ uuid }, #{ totalId }, #{ title }, #{ contributor }, #{ eDescription },
				#{ eventSite }, #{ detailEventSite }, #{ latitude }, #{ longitude }, #{ genre },
				#{ contactPoint }, #{ viewCounter }, #{ eUrl }, #{ startDate }, #{ endDate },
				#{ approvalStatus }, #{ eCategory }, #{ fileUrl })
	</insert>
	<update id="updateMember" parameterType="OrgRegist">			
		update tb_member
		set name = #{ name }, mng_dept = #{ mngDept }, mng_jobid = #{ mngJobId },
			phone = #{ phone }, email = #{ email }
		where uuid = #{ uuid }
	</update>
	
	<!-- 전시/박람회 등록시 필요한 totalid + 1 작업용 -->
	<select id="selectMaxTotalId" resultType="_int">
		select max(to_number(total_id))
		from tb_exhibition_fair
	</select>
	 
	<!-- 전시/박람회 정보 불러오기 -->
    <select id="selectOrgRegistByUuid" parameterType="string" resultMap="resultOrgRegist">
        select *
		from tb_exhibition_fair
		right join tb_member using (uuid)
		where uuid = #{ uuid } and rownum = 1
    </select>
    
    <!-- 전시/박람회 정보 수정하기 디테일페이지 -->
    <select id="selectOrgTotalId" parameterType="string" resultMap="resultOrgRegist">
        select *
		from tb_exhibition_fair
		join tb_member using (uuid)
		where total_id = #{ totalId }
    </select>
    
    <!-- 전시/박람회 정보 수정하기 -->
    <update id="updateOrgRegist" parameterType="OrgRegist">
    	update tb_exhibition_fair
    	set TITLE = #{ title }, CONTRIBUTOR = #{ contributor }, E_DESCRIPTION = #{ eDescription },
			EVENT_SITE = #{ eventSite }, DETAIL_EVENT_SITE = #{ detailEventSite }, LATITUDE = #{ latitude },
			LONGITUDE = #{ longitude }, GENRE = #{ genre }, CONTACT_POINT = #{ contactPoint },
			VIEW_COUNTER = #{ viewCounter }, E_URL = #{ eUrl }, START_DATE = #{ startDate }, END_DATE = #{ endDate },
			APPROVAL_STATUS = #{ approvalStatus }, E_CATEGORY = #{ eCategory }, FILE_URL = #{ fileUrl }
		where TOTAL_ID = #{ totalId }
    </update>
    
    <!-- total_id(pk)로 전시등록 삭제하기 -->
    <delete id="deleteOrgRegist" parameterType="string">
    	delete tb_exhibition_fair
		where total_id = #{ totalId }
    </delete>
    
    
    <!-- 관리자용 쿼리 -->
    <!-- 등록 신청 건 중 미승인 갯수 조회 -->
    <select id="selectApCount" resultType="_int">
    	select count(*)
    	from tb_exhibition_fair
    	where APPROVAL_STATUS = 'N'
    </select>
    
    <!-- 요청한 페이지에 출력할 등록신청 미승인 리스트 조회용 쿼리 -->
	<select id="selectApList" resultMap="resultOrgRegist" parameterType="Paging">
		select *
		from (select rownum rnum, TITLE, CONTRIBUTOR, START_DATE, END_DATE, TOTAL_ID, E_CATEGORY
		      from (select *
		            from tb_exhibition_fair
		            join tb_member using (uuid)
		            where APPROVAL_STATUS = 'N'
		            order by e_category, start_date))
		where rnum between #{ startRow } and #{ endRow }
	</select>
	
	<!-- 등록상태 Y로 변경 -->
	<update id="apStatusYn" parameterType="string">
		update tb_exhibition_fair
    	set APPROVAL_STATUS = 'Y'
    	where TOTAL_ID = #{ totalId }
	</update>
</mapper>
